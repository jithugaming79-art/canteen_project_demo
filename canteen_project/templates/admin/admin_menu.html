{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Menu Items{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <h1>Menu Items</h1>
        <p>{{ items|length }} items across {{ categories|length }} categories</p>
    </div>
    <div class="page-header-right">
        <button class="admin-btn admin-btn-primary"
            onclick="const m=document.getElementById('addItemModal'); m.classList.add('show'); m.style.display='flex'">
            + Add Item
        </button>
    </div>
</div>

<!-- Category Filter Tabs -->
<div class="filter-tabs-row">
    <a href="?category=all" class="filter-tab-btn {% if category_filter == 'all' %}active{% endif %}">All</a>
    {% for cat in categories %}
    <a href="?category={{ cat.name }}" class="filter-tab-btn {% if category_filter == cat.name %}active{% endif %}">
        {{ cat.name }}
    </a>
    {% endfor %}
</div>

<!-- Menu Card Grid -->
<div class="menu-cards-grid">
    {% for item in items %}
    <div class="menu-card">
        <div class="menu-card-image bg-pastel-{{ forloop.counter0|divisibleby:8|add:forloop.counter0 }}">
            {% if item.image %}
            <img src="{{ item.image.url }}" alt="{{ item.name }}">
            {% else %}
            <div class="menu-card-placeholder bg-pastel-{{ forloop.counter|add:0 }}">
                {{ item.name|truncatechars:30 }}
            </div>
            {% endif %}
            <div class="menu-card-price-tag">₹{{ item.price|floatformat:0 }}</div>
        </div>
        <div class="menu-card-body">
            <div class="menu-card-name">{{ item.name }}</div>
            <div class="menu-card-category">{{ item.category.name }}</div>
            <div class="menu-card-footer">
                <form method="post" class="menu-card-toggle">
                    {% csrf_token %}
                    <input type="hidden" name="toggle_item" value="1">
                    <input type="hidden" name="item_id" value="{{ item.id }}">
                    <label class="toggle-switch" title="Toggle availability">
                        <input type="checkbox" {% if item.is_available %}checked{% endif %}
                            onchange="this.form.submit()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="item-status-text {% if item.is_available %}live{% else %}off{% endif %}">
                        {% if item.is_available %}Live{% else %}Off{% endif %}
                    </span>
                </form>
                <div class="menu-card-actions">
                    <button type="button" class="action-btn"
                        style="color: var(--admin-primary); background: rgba(59,130,246,0.1);" title="Edit"
                        onclick="openEditModal({{ item.id }}, '{{ item.name|escapejs }}', '{{ item.category.id }}', '{{ item.price }}', '{{ item.preparation_time }}', '{{ item.description|escapejs }}', {{ item.is_vegetarian|yesno:'true,false' }})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </button>
                    <form method="post" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="delete_item" value="1">
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <button type="submit" class="action-btn delete" title="Delete"
                            onclick="return confirm('Delete {{ item.name }}?')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="admin-empty" style="grid-column:1/-1;">
        <div class="admin-empty-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
                stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.2;">
                <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                <line x1="6" y1="1" x2="6" y2="4"></line>
                <line x1="10" y1="1" x2="10" y2="4"></line>
                <line x1="14" y1="1" x2="14" y2="4"></line>
            </svg>
        </div>
        <h3>No menu items</h3>
        <p>Add your first menu item to get started</p>
    </div>
    {% endfor %}
</div>

<!-- ══════ Add Item Modal ══════ -->
<div class="admin-modal" id="addItemModal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h2>Add Menu Item</h2>
            <button class="admin-btn-ghost"
                onclick="const m=document.getElementById('addItemModal'); m.classList.remove('show'); setTimeout(()=>m.style.display='none',300)"
                style="font-size:18px;">✕</button>
        </div>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="add_item" value="1">
            <div class="admin-modal-body">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" name="name" class="form-input" required placeholder="Enter item name...">
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="form-group">
                        <label>Category</label>
                        <select name="category" class="form-select" required>
                            <option value="" disabled selected>Select category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" name="image" class="form-input" accept="image/*" style="padding: 6px 12px;">
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="form-group">
                        <label>Price (₹)</label>
                        <input type="number" name="price" class="form-input" required step="0.01" min="0"
                            placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Preparation Time (min)</label>
                        <input type="number" name="preparation_time" class="form-input" value="10" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" class="form-input" rows="3"
                        placeholder="Write a short description of the item..."></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="toggle-switch-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" name="is_vegetarian" checked
                            style="width:18px;height:18px;accent-color:var(--admin-accent);">
                        <span style="font-size:14px;font-weight:600;">Mark as Vegetarian</span>
                    </label>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button type="button" class="admin-btn admin-btn-outline"
                    onclick="const m=document.getElementById('addItemModal'); m.classList.remove('show'); setTimeout(()=>m.style.display='none',300)">Cancel</button>
                <button type="submit" class="admin-btn admin-btn-primary">Add Item</button>
            </div>
        </form>
    </div>
</div>

<!-- ══════ Edit Item Modal ══════ -->
<div class="admin-modal" id="editItemModal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h2>Edit Menu Item</h2>
            <button class="admin-btn-ghost"
                onclick="const m=document.getElementById('editItemModal'); m.classList.remove('show'); setTimeout(()=>m.style.display='none',300)"
                style="font-size:18px;">✕</button>
        </div>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="edit_item" value="1">
            <input type="hidden" name="item_id" id="edit_item_id" value="">
            <div class="admin-modal-body">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" name="name" id="edit_name" class="form-input" required
                        placeholder="Enter item name...">
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="form-group">
                        <label>Category</label>
                        <select name="category" id="edit_category" class="form-select" required>
                            <option value="" disabled>Select category</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Image (Leave blank to keep current)</label>
                        <input type="file" name="image" class="form-input" accept="image/*" style="padding: 6px 12px;">
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="form-group">
                        <label>Price (₹)</label>
                        <input type="number" name="price" id="edit_price" class="form-input" required step="0.01"
                            min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Preparation Time (min)</label>
                        <input type="number" name="preparation_time" id="edit_prep_time" class="form-input" value="10"
                            min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" id="edit_description" class="form-input" rows="3"
                        placeholder="Write a short description of the item..."></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="toggle-switch-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" name="is_vegetarian" id="edit_is_vegetarian"
                            style="width:18px;height:18px;accent-color:var(--admin-accent);">
                        <span style="font-size:14px;font-weight:600;">Mark as Vegetarian</span>
                    </label>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button type="button" class="admin-btn admin-btn-outline"
                    onclick="const m=document.getElementById('editItemModal'); m.classList.remove('show'); setTimeout(()=>m.style.display='none',300)">Cancel</button>
                <button type="submit" class="admin-btn admin-btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModal(id, name, categoryId, price, prepTime, description, isVeg) {
        document.getElementById('edit_item_id').value = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_category').value = categoryId;
        const parsedPrice = parseFloat(price);
        document.getElementById('edit_price').value = !isNaN(parsedPrice) ? parsedPrice.toFixed(2) : '0.00';
        document.getElementById('edit_prep_time').value = prepTime;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_is_vegetarian').checked = isVeg;

        const m = document.getElementById('editItemModal');
        m.style.display = 'flex';
        // Small timeout to allow display:flex to apply before adding the opacity transition class
        setTimeout(() => m.classList.add('show'), 10);
    }
</script>

{% endblock %}